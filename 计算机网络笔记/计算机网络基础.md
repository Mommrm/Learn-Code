## 计算机网络基础

### 网络分层模型

OSI模型：
![Alt text](images/OSImodel.png)

TCP/IP模型：
![Alt text](images/TCP.IPmodel.png)

### 分层解释

#### 应用层
- 手机或电脑之间应用的通信，如果是不同设备之间的应用要通信，应该把应用数据传到下一层
- 工作在操作系统的用户态
- 协议：HTTP、FTP、Telnet、DNS、SMTP

#### 传输层
- 为应用层提供网络支持的，不同设备之间的应用传输数据(端口号知道其要传输的应用)
- 协议有两个TCP(Transmission Control Protocol)、UDP协议
- 工作在操作系统的内核态
  
#### 网络层
- 实际传输数据的层，在传输层是服务于应用
- 协议：IP协议(主要是寻址功能，把数据包发送到目的地)


#### 网络接口层
为网络层提供链路级别的传输服务、负责底层网络发送原始数据包(二进制转换为波形等)


### 键入网址到网页显示发生了什么？

#### 应用层
1. HTTP(解析URL并生成HTTP消息)
> 解析URL(http://www.baidu.com/index.html)
解析：http表示的是数据访问的协议，//后面是服务器名称，/后面是服务器文件的路径(可省略)

> 对URL进行解析之后确定了服务器和文件名，接下来就是根据这些信息生成HTTP请求(GET\POST)

2. DNS(找出服务器名称和IP地址的对应关系)
> 先去缓存中查找是否有对应关系(浏览器缓存、操作系统缓存、hosts文件)

> 本地DNS服务器

> 根域名服务器(.)、顶级域名服务器(com、cn)、权威域名服务器(baidu.com)

3. 协议栈(过渡)
> 应用层：通过调用Socket库来委托协议栈工作
> 上半部分是：TCP或UDP协议(负责收发数据)
> 下半部分是：IP协议(包括ICMP协议和ARP协议)

4. TCP(建立可靠传输通道，为数据提供可靠的传输信息)
##### 先简单了解TCP报文头部格式：
> 源端口和目标端口号: 解决数据哪个应用到哪个应用的问题
> 序号：解决包乱序问题
> 确认号：确认对方是否收到，解决丢包问题
> 状态位：SYN(发起连接)、ACK(确认收到)、FIN(结束连接)、RST(连接中断)
> 窗口大小：通信双方各声明一个窗口大小(流量控制、拥塞控制)

##### 三次握手：
客户端A、服务端B
> 客户端生成一个SYN帧发送给服务端，A由CLOSE进入SYN_SEND状态
> B接收到SYN帧后，发送一个SYN+ACK帧返回给A，B由LISTEN进入SYN_RCVD状态
> A接收到后，发送一个ACK帧确认连接，A由SYN_SEND进入ESTABLISHED状态，B由SYN_RCVD进入ESTABLISHED状态

##### TCP分割数据
MTU：一个网络包最大长度，以太网中一般为1500字节(IP头部、TCP头部、数据部分)
MSS：最大报文长度

##### TCP报文生成
TCP两个端口：一个是浏览器监听的端口，一个是服务器监听的端口(HTTP:80,HTTPS:443)

TCP报文：TCP头部+数据部分(HTTP头部＋数据部分)

5. IP(加上IP头部+TCP头部+HTTP头部+数据部分)
> 协议号 06(十六进制)表示TCP
> 主要是找到目的IP地址，路由匹配等

6. MAC(加上MAC头部)
组成：
接收方MAC:通过ARP协议(先缓存判断，再广播形式)
发送方MAC:直接读取网卡的MAC地址
协议类型:0800(IP协议)、0806(ARP协议)（在TCP/IP通信中一般是这两种协议)

7. 出门
根据以上加了各种头部之后就可以出门了

##### 网卡

把上面生成的数据包复制到网卡内的缓存区，加上开头的报头和起始帧分界符，末尾加上FCS(检测错误的帧校验)
加上这些后，网卡还会把包转换为电信号

##### 交换机(二层网络设备,有很多端口，每个端口有对应MAC地址)
电信号转换为数字信号，校验FCS

工作在MAC层，根据包里面的接收方MAC地址，查看交换机MAC地址表
- 如果匹配直接发送
- 不匹配就转发包，除了源端口外其他端口都转发
- 如果接收方地址是广播地址(FF:FF:FF:FF:FF:FF)，就把包发给除了源端口外的其他端口

##### 路由器(三层网络设备，有很多端口，每个端口对应MAC地址和IP地址)
电信号转换为数字信号，校验FCS，判断MAC头部是否是发给自己的包

完成包接收后会去掉MAC头部，MAC 头部的作用就是将包送达路由器

和交换机类似，不过这时判断的是IP地址
找到目的网络的子网

路由器发送：
- 根据路由表的网关列判断对方地址：
  - 网关是一个IP地址，说明还未抵达终点
  - 网关为空，说明已经到达了终点

知道了下一跳路由器的IP地址，还要通过ARP协议获取下一条路由器的MAC地址(路由器也有ARP缓存)

到达下一条路由器之后继续上述过程，直到到达终点(终点是由上面IP头部的目的IP来判断的)

因此无论怎么路由都是通过MAC地址来实现的

8. 服务端解析数据包





